(()=>{"use strict";const t=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/","="],n=[],e=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","-","_","="],r=[];for(let o=0;o<t.length;o++)n[t[o].charCodeAt(0)]=o,r[e[o].charCodeAt(0)]=o;const o=function(n,e,r){e=e||t;for(var o,c,i,u,s="",f="",a="",d=0,l=n.length,h=l-l%3,p=0;d<h;)i=(3&(o=n[d++]))<<4|(c=n[d++])>>4,u=(15&c)<<2|(f=n[d++])>>6,a=63&f,s+=e[o>>2]+e[i]+e[u]+e[a],r>0&&(p+=4)%r==0&&(s+="\r\n");return l-h==2?(o=n[d++],c=n[d++],s+=e[o>>2]+e[(3&o)<<4|c>>4]+e[(15&c)<<2]+"="):l-h==1&&(s+=e[(o=n[d++])>>2]+e[(3&o)<<4]+"=="),"\n"===s.charAt(s.length-1)&&(s=s.substr(0,s.length-2)),s},c=function(t,e){if(e=e||n,""===(t=t.replace(/\s/g,"")))return[];var r,o,c,i,u,s=[],f="",a=0,d=t.length,l=d;for("="===t.slice(-1)&&(l=d-4);a<l;)r=(c=e[t.charCodeAt(a++)])<<2|(i=e[t.charCodeAt(a++)])>>4,o=(15&i)<<4|(u=e[t.charCodeAt(a++)])>>2,f=(3&u)<<6|e[t.charCodeAt(a++)],s.push(r,o,f);return d!==l&&(c=e[t.charCodeAt(a++)],i=e[t.charCodeAt(a++)],"=="===t.slice(-2)?s.push(c<<2|i>>4):"="===t.slice(-1)&&(u=e[t.charCodeAt(a++)],s.push(c<<2|i>>4,(15&i)<<4|u>>2))),s},i={encode:o,decode:c},u={encode:function(t,n){return o(t,e,n).replace(/=+$/,"")},decode:function(t){for(;t.length%4!=0;)t+="=";return c(t,r)}},s={Boolean:1,Integer:2,BitString:3,OctetString:4,Null:5,ObjectIdentifier:6,Enumerated:10,Sequence:16,Set:17,UTF8String:12,NumericString:18,PrintableString:19,T61String:20,IA5String:22,UTCTime:23,GeneralizedTime:24,VisibleString:26,GeneralString:27,BMPString:30,TagNumberMask:31,ConstructedFlag:32,ConstructedSequence:48,ConstructedSet:49,ContextSpecificTagFlag:128,ContextSpecificConstructedTag0:160,ContextSpecificConstructedTag1:161,ContextSpecificConstructedTag2:162,ContextSpecificConstructedTag3:163,TagClassMask:192,VALUE_NAME_MAP:{16:"SEQUENCE",17:"SET",48:"SEQUENCE",49:"SET",6:"OBJECT IDENTIFIER",2:"INTEGER",1:"BOOLEAN",3:"BIT STRING",4:"OCTET STRING",5:"NULL"}};for(const t in s)s.hasOwnProperty(t)&&"VALUE_NAME_MAP"!==t&&!s.VALUE_NAME_MAP.hasOwnProperty(s[t])&&(s.VALUE_NAME_MAP[s[t]]=t);const f=s,a={decode:function(t,n,e){n=void 0===n?0:n,e=void 0===e?t.length:e;let r="";const o=t[n];r+=Math.floor(o/40)+"."+o%40;let c,i,u=!0,s=0;for(let o=1;o<e;o++)c=t[n+o],i=127&c,u&&(r+=".",u=!1),s<<=7,s+=i,c===i&&(r+=s,s=0,u=!0);return r},encode:function(t){const n=t.split(".").map((t=>parseInt(t))),e=[];e.push(40*n[0]+n[1]);for(let t=2;t<n.length;t++){let r=n[t];if(r<=127){e.push(r);continue}const o=[];let c=!1;for(;r>0;){let t=127&r;c&&(t|=128),o.unshift(t),r>>=7,c||(c=!0)}Array.prototype.push.apply(e,o)}return e}};function d(t,n,e){let r=null;if("string"==typeof t){if(void 0!==n)throw new Error("expect 'undefined' for argument offset");r=t,n=0,e=(t=function(t){const n=[];for(let e=0;e<t.length;e++){const r=t.charCodeAt(e);r<=127?n.push(r):r<=2047?n.push(r>>6|192,63&r|128):r<=65535?n.push(r>>12|224,r>>6&63|128,63&r|128):n.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}return n}(r)).length}if(n+e>t.length)throw new Error("offset out of range");void 0===n&&(n=0),void 0===e&&(e=t.length);const o=n,c=e;let i=n;const u=n+e;function s(){const n=t[i];return n<128?1:n<224?2:n<240?3:4}function f(){const n=t[i++];if(n<128)return n;const e=t[i++];if(n<224)return(31&n)<<6|63&e;const r=t[i++];if(n<240)return(15&n)<<12|(63&e)<<6|63&r;return(7&n)<<18|(63&e)<<12|(63&r)<<6|63&t[i++]}return{toString:function(){if(null!==r)return r;const t=[];for(;i<u;){const n=s();if(i+n>u)throw new Error("unformed utf8 bytes array");t.push(f())}return r=String.fromCharCode.apply(null,t)},getBytesArray:()=>t.slice(o,o+c)}}const l=function(t,n){if(n instanceof Uint8Array){const t=[];n.forEach((n=>{t.push(n)})),n=t}Array.prototype.push.apply(t,n)};function h(t,n){return n=n||[],{encode(e){"function"==typeof n&&(n=n()),"string"==typeof n&&(n=n.split("").map((t=>t.charCodeAt(0)))),g(t,n.length,e),l(e,n)}}}function p(t,...n){if(1===n.length&&"function"==typeof n[0]){const t=[];n[0](t),n=t}return{encode(e){const r=[];n.forEach((t=>t&&t.encode(r))),function(t,n,e){g(t,n.length,e),l(e,n)}(t,r,e)}}}function g(t,n,e){e.push(t),function(t,n){if(t<128)return void n.push(t);const e=[];let r=0;for(;t>0;)e.unshift(255&t),t>>=8,r++;e.unshift(128|r),l(n,e)}(n,e)}function y(t,...n){return p(f.ContextSpecificTagFlag|f.ConstructedFlag|t,...n)}function E(...t){return p(f.Sequence|f.ConstructedFlag,...t)}function C(...t){return p(f.Set|f.ConstructedFlag,...t)}function S(){return h(f.Null)}function A(t){return{encode(n){l(n,t)}}}function T(t){return{encode(n){g(f.BitString,t.length+1,n),n.push(0),l(n,t)}}}function v(t,n){let e=[];if(t instanceof Uint8Array){const n=[];t.forEach((t=>{n.push(t)})),t=n}if(t instanceof Array){for(e=t,!0===n&&e.reverse();0===e[0];)e.shift();(128&e[0])>0&&e.unshift(0)}else if("number"==typeof t){for(;t>255;)e.unshift(255&t),t>>=8;e.unshift(t),(128&t)>0&&e.unshift(0)}return h(f.Integer,e)}function w(t){return"string"==typeof t&&(t=a.encode(t)),h(f.ObjectIdentifier,t)}function P(t){return h(f.OctetString,t)}function _(t){return h(f.UTF8String,d(t).getBytesArray())}const b={"P-256":"1.2.840.10045.3.1.7","P-384":"1.3.132.0.34","P-521":"1.3.132.0.35"},U={O:"2.5.4.10",OU:"2.5.4.11",C:"2.5.4.6",ST:"2.5.4.8",L:"2.5.4.7",Street:"2.5.4.9",E:"1.2.840.113549.1.9.1"},I={O:_,OU:_,C:function(t){return h(f.PrintableString,t)},ST:_,L:_,Street:_,E:function(t){return h(f.IA5String,t)}},m="1.2.840.10045.4.3.2",O="1.2.840.113549.1.1.11";function k(t){const n="EC"===t.kty,e=[];return E(v(0),E(w(n?"1.2.840.10045.2.1":"1.2.840.113549.1.1.1"),n?w(b[t.crv]):S()),P(n?function(t){const n=[];return E(v(1),P(u.decode(t.d)),y(0,w(b[t.crv])),y(1,T([4,...u.decode(t.x),...u.decode(t.y)]))).encode(n),n}(t):function(t){t.kty;const n=[];return E(v(0),v(u.decode(t.n)),v(u.decode(t.e)),v(u.decode(t.d)),v(u.decode(t.p)),v(u.decode(t.q)),v(u.decode(t.dp)),v(u.decode(t.dq)),v(u.decode(t.qi))).encode(n),n}(t))).encode(e),e}function N(t){const n="EC"===t.kty,e=[];return E(E(w(n?"1.2.840.10045.2.1":"1.2.840.113549.1.1.1"),n?w(b[t.crv]):S()),T(n?function(t){return[4,...u.decode(t.x),...u.decode(t.y)]}(t):function(t){const n=[];return E(v(u.decode(t.n)),v(u.decode(t.e))).encode(n),n}(t))).encode(e),e}function B(t){return crypto.subtle.exportKey("jwk",t).then((t=>({private_key:k(t),public_key:N(t)})))}function x(t,n){return"-----BEGIN "+t+"-----\r\n"+i.encode(n,null,64)+"\r\n-----END "+t+"-----\r\n"}function R(t,n){return n[t]?C(E(w(U[t]),I[t](n[t]))):null}function F(t,n){return"ECC"===t?(r=n||"P-384",crypto.subtle.generateKey({name:"ECDSA",namedCurve:r},!0,["sign","verify"])):(e=n||2048,crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",publicExponent:new Uint8Array([1,0,1]),modulusLength:e,hash:"SHA-256"},!0,["sign","verify"]));var e,r}function L(t,n){if("ECC"!==t&&"RSA"!==t)throw new Error("only support: ECC/RSA");if("ECC"===t&&"P-256"!==n&&"P-384"!==n&&"P-521"!==n&&void 0!==n)throw new Error("only support: P-256/P-384/P-521, default: P-384");if("RSA"===t&&2048!==n&&4096!==n&&void 0!==n)throw new Error("only support: 2048/4096, default: 2048")}const K=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],M=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"],V={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,a:10,b:11,c:12,d:13,e:14,f:15,A:10,B:11,C:12,D:13,E:14,F:15};const q={parse:function(t){if(t.length%2!=0)throw new Error("invalid hex data, length error");const n=[];for(let e=0;e<t.length;e+=2){const r=V[t.substr(e,1)],o=V[t.substr(e+1,1)];if(void 0===r||void 0===o)throw new Error("invalid hex data, char error");n.push(r<<4|o)}return n},stringify:function(t,n){const e=[],r=!0===n?M:K;for(let n=0;n<t.length;n++)e.push(r[t[n]>>4]+r[15&t[n]]);return e},transfer:function(t){return K[t>>4]+K[15&t]}};window.X509={csr:function(t){const n=t,e=[],r={};function o(t,n){return void 0===n?r[t]:(r[t]=n,c)}const c={add_san:t=>c.san(t),san:t=>(t instanceof Array||(t=[t]),t.forEach((t=>{t&&-1===e.indexOf(t)&&e.push(t)})),c),clear_san:()=>(e.length=0,c),org:t=>o("O",t),org_unit:t=>o("OU",t),country:t=>o("C",t),state:t=>o("ST",t),location:t=>o("L",t),street:t=>o("Street",t),email:t=>o("E",t),generate:(t,o)=>async function(t,n,e,r,o){L(e,r),n&&0!==n.length||(n=[t]);o=o||{};const c=await F(e,r),i=await B(c.privateKey),u=function(t,n,e,r){const o=E(v(0),E(C(E(w("2.5.4.3"),_(t))),R("O",n),R("OU",n),R("C",n),R("ST",n),R("L",n),R("Street",n),R("E",n)),A(r),y(0,E(w("1.2.840.113549.1.9.14"),C(E(E(w("2.5.29.17"),P(function(t){const n=[];return E((function(n){t.forEach((t=>{var e,r;n.push((e=2,r=d(t).getBytesArray(),h(e|f.ContextSpecificTagFlag,r)))}))})).encode(n),n}(e)))))))),c=[];return o.encode(c),c}(t,o,n,i.public_key),s=await function(t,n,e){const r="RSA"===e?{name:"RSASSA-PKCS1-v1_5"}:{name:"ECDSA",hash:"SHA-256"};return crypto.subtle.sign(r,t,new Uint8Array(n)).then((t=>{const n=new Uint8Array(t);if("RSA"===e)return n;const r=[];return E(v(n.slice(0,n.length/2)),v(n.slice(n.length/2))).encode(r),r}))}(c.privateKey,u,e),a=function(t,n,e){const r=[];return E(A(n),E(w("ECC"===t?m:O),"ECC"===t?A([]):S()),T(e)).encode(r),r}(e,u,s);return{private_key:x("PRIVATE KEY",i.private_key),public_key:x("PUBLIC KEY",i.public_key),csr:x("CERTIFICATE REQUEST",a)}}(n,e,t,o,r)};return c},generate_asymmetric_keypair:async function(t,n){L(t,n);const e=await F(t,n),r=await B(e.privateKey);return{private_key:x("PRIVATE KEY",r.private_key),public_key:x("PUBLIC KEY",r.public_key)}},utils:{Base64:i,UrlSafeBase64:u,UTF8String:d,Hex:q}}})();